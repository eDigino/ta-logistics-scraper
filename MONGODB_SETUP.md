# MongoDB Atlas Setup Guide

This guide will help you set up MongoDB Atlas and resolve connection issues.

## TL;DR - Quick Fix for TLS/SSL Errors

If you're getting **TLS/SSL connection errors**, it's usually one of these issues:

1. ❌ **Wrong Password** - Double-check your password in MongoDB Atlas
2. ❌ **IP Not Whitelisted** - Add your IP to Network Access
3. ❌ **User Doesn't Exist** - Verify the database user exists
4. ❌ **Wrong Permissions** - User needs read/write access

## Step-by-Step Setup

### 1. Create MongoDB Atlas Account

1. Go to [https://www.mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas)
2. Click "Try Free"
3. Sign up with your email or Google account
4. Verify your email address

### 2. Create a Cluster

1. After logging in, click **"Build a Database"**
2. Choose **M0 FREE** tier
3. Select your preferred cloud provider and region
4. Click **"Create"** (keep default cluster name or change it)
5. Wait 1-3 minutes for cluster to deploy

### 3. Create Database User

⚠️ **This is the most common source of errors!**

1. On the left sidebar, click **"Database Access"**
2. Click **"Add New Database User"**
3. Choose **"Password"** authentication method
4. Enter a username (e.g., `db_user`)
5. **IMPORTANT:** Click **"Autogenerate Secure Password"** and **COPY IT IMMEDIATELY**
   - OR create your own password (**write it down!**)
   - Avoid special characters if possible (they need URL encoding)
   - If using special characters, you'll need to URL-encode them later
6. Under "Database User Privileges", select **"Read and write to any database"**
7. Click **"Add User"**

**Common Mistakes:**
- ❌ Using your MongoDB Atlas account password (this is different!)
- ❌ Forgetting to copy the autogenerated password
- ❌ Using special characters without URL encoding

### 4. Configure Network Access

⚠️ **Second most common source of errors!**

1. On the left sidebar, click **"Network Access"**
2. Click **"Add IP Address"**
3. For testing/development:
   - Click **"Allow Access from Anywhere"** (adds `0.0.0.0/0`)
   - ⚠️ This is fine for development but not recommended for production
4. Or add your specific IP:
   - Click **"Add Current IP Address"**
   - Note: You'll need to update this if your IP changes
5. Click **"Confirm"**
6. Wait for the status to change from "Pending" to "Active" (30-60 seconds)

**Common Mistakes:**
- ❌ Not waiting for IP whitelist to become active
- ❌ IP address changed after whitelisting
- ❌ Firewall blocking MongoDB connections

### 5. Get Connection String

1. Go to **"Database"** in the left sidebar
2. Click **"Connect"** button on your cluster
3. Choose **"Connect your application"**
4. Select **"Node.js"** as the driver
5. Copy the connection string

**It will look like this:**
```
mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority
```

### 6. Configure .env File

1. In your project folder, copy the example file:
   ```bash
   cp env.example .env
   ```

2. Open `.env` in a text editor

3. Replace the entire `MONGODB_URI` line with your connection string

4. Replace `<username>` with your database username (from step 3)

5. Replace `<password>` with your database password (from step 3)

**Example:**
```env
# Before:
MONGODB_URI=mongodb+srv://your_username:your_password@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority

# After (example - use your actual values):
MONGODB_URI=mongodb+srv://db_user:MySecurePass123@scrapping-tool.dddycyc.mongodb.net/?retryWrites=true&w=majority

DATABASE_NAME=copart_scraper
COLLECTION_NAME=vehicles
```

### 7. Handle Special Characters in Password

If your password contains special characters, they **MUST** be URL-encoded:

| Character | Encoded | Character | Encoded |
|-----------|---------|-----------|---------|
| @         | %40     | #         | %23     |
| :         | %3A     | [         | %5B     |
| /         | %2F     | ]         | %5D     |
| ?         | %3F     | space     | %20     |

**Example:**
- Password: `MyP@ss:123`
- Encoded: `MyP%40ss%3A123`

### 8. Test Your Connection

Run the validation script:
```bash
npm run validate-env
```

If validation passes, test the actual connection:
```bash
npm run test-db
```

## Troubleshooting

### Error: TLS/SSL Connection Failed

This is the most common error. Here's how to fix it:

#### Solution 1: Verify Your Password
1. Go to MongoDB Atlas → Database Access
2. Find your database user
3. Click "Edit"
4. Click "Edit Password"
5. Autogenerate a new password
6. **Copy it immediately**
7. Update `.env` file with new password
8. Test again: `npm run test-db`

#### Solution 2: Check IP Whitelist
1. Go to MongoDB Atlas → Network Access
2. Verify your current IP is listed or `0.0.0.0/0` is allowed
3. Wait for status to be "Active" (not "Pending")
4. If you see your IP but still have issues, try:
   - Remove the entry
   - Add "Allow Access from Anywhere" (0.0.0.0/0)
   - Wait 1 minute
   - Test again

#### Solution 3: Recreate Database User
Sometimes the user configuration gets corrupted:

1. Go to MongoDB Atlas → Database Access
2. Delete the existing user
3. Create a new user (see Step 3 above)
4. Use autogenerated password
5. Give "Read and write to any database" permission
6. Update `.env` with new credentials
7. Test again

#### Solution 4: Check Cluster Status
1. Go to MongoDB Atlas → Database
2. Verify your cluster shows a green "Connected" status
3. If it says "Paused", click "Resume" (free clusters auto-pause after inactivity)

### Error: Server Selection Timeout

This means the MongoDB server isn't reachable:

1. Check your internet connection
2. Verify IP whitelist (see above)
3. Try a different network (mobile hotspot to test)
4. Check if your firewall blocks MongoDB (port 27017)

### Error: Bad Authentication

The username or password is wrong:

1. Verify you're using the **database user** credentials, not your Atlas account credentials
2. Check for typos in username/password
3. URL-encode special characters in password
4. Try creating a new database user with a simple password (only letters and numbers)

### Connection String Issues

Make sure your connection string:
- ✅ Starts with `mongodb+srv://` (for Atlas)
- ✅ Has format: `mongodb+srv://username:password@cluster.mongodb.net/`
- ✅ Uses your actual cluster address (not `cluster0.xxxxx`)
- ✅ Doesn't have spaces or line breaks
- ✅ Has `?retryWrites=true&w=majority` at the end

### Still Having Issues?

1. **Start fresh:**
   - Delete the database user in MongoDB Atlas
   - Create a new user with autogenerated password (no special characters)
   - Set IP whitelist to 0.0.0.0/0
   - Get a fresh connection string
   - Update `.env` completely

2. **Verify step-by-step:**
   ```bash
   # Step 1: Validate configuration
   npm run validate-env
   
   # Step 2: Test connection
   npm run test-db
   ```

3. **Check MongoDB Atlas status:**
   - Go to [https://status.mongodb.com/](https://status.mongodb.com/)
   - Verify there are no outages

## Quick Checklist

Before asking for help, verify:

- [ ] Cluster is deployed and running (green "Connected" in Atlas)
- [ ] Database user exists with read/write permissions
- [ ] You copied the database user password (not your Atlas account password)
- [ ] IP whitelist includes your IP or 0.0.0.0/0
- [ ] IP whitelist status is "Active" (not "Pending")
- [ ] Connection string starts with `mongodb+srv://`
- [ ] `.env` file exists and has no placeholder values
- [ ] `npm run validate-env` passes
- [ ] Special characters in password are URL-encoded (if any)

## Need More Help?

If you've followed all steps and still have issues:

1. Run diagnostics:
   ```bash
   npm run validate-env
   npm run test-db
   ```

2. Check the error message carefully - it often indicates the specific problem

3. Review the Troubleshooting section in `README.md`

4. Common solutions that work 90% of the time:
   - Recreate database user with simple password (letters/numbers only)
   - Set IP whitelist to 0.0.0.0/0
   - Get fresh connection string from Atlas

